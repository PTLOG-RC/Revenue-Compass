<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Revenue Compass - Income Tracker for Personal Trainers</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { background: #111827; margin: 0; }
    * { box-sizing: border-box; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    // ==================================================
    // REPLACE THESE TWO LINES WITH YOUR SUPABASE KEYS
    // ==================================================
    const SUPABASE_URL = 'https://wjaqbxxlnmcosnzzktza.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndqYXFieHhsbm1jb3NuenprdHphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MTc5NzAsImV4cCI6MjA4NzE5Mzk3MH0.HuHA43JsQEUu9KRO95uDTl83Rpj528bJJdBv5KI5rhI';
    // ==================================================
    
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const { useState, useEffect } = React;

    const Modal = ({ title, children, onClose }) => (
      <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50" onClick={onClose}>
        <div className="bg-gray-800 border border-gray-700 rounded-2xl p-6 w-full max-w-md mx-4" onClick={e => e.stopPropagation()}>
          <div className="flex items-center justify-between mb-6">
            <h3 className="text-xl font-semibold text-white">{title}</h3>
            <button onClick={onClose} className="text-gray-400 hover:text-white text-xl">âœ•</button>
          </div>
          {children}
        </div>
      </div>
    );

    const MetricCard = ({ icon, value, label, trend, color }) => (
      <div className="bg-gray-800/50 backdrop-blur border border-gray-700/50 rounded-2xl p-5 hover:border-gray-600 transition-all">
        <div className="flex items-start justify-between">
          <div className={`w-12 h-12 rounded-xl ${color} flex items-center justify-center text-2xl`}>{icon}</div>
          {trend && (
            <span className={`text-xs px-2 py-1 rounded-full ${trend > 0 ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'}`}>
              {trend > 0 ? 'â†‘' : 'â†“'} {Math.abs(trend)}%
            </span>
          )}
        </div>
        <div className="mt-4">
          <div className="text-3xl font-bold text-white">{value}</div>
          <div className="text-gray-400 text-sm mt-1">{label}</div>
        </div>
      </div>
    );

    const ProgressBar = ({ current, goal, label }) => {
      const percentage = goal > 0 ? Math.min((current / goal) * 100, 100) : 0;
      return (
        <div className="mb-4">
          <div className="flex justify-between mb-1">
            <span className="text-gray-400 text-sm">{label}</span>
            <span className="text-white text-sm font-medium">{current} / {goal}</span>
          </div>
          <div className="h-2 bg-gray-700 rounded-full overflow-hidden">
            <div className="h-full rounded-full bg-gradient-to-r from-cyan-500 to-cyan-400 transition-all duration-500" style={{ width: `${percentage}%` }} />
          </div>
        </div>
      );
    };

    const AuthScreen = ({ onLogin }) => {
      const [isLogin, setIsLogin] = useState(true);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          if (isLogin) {
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) throw error;
            onLogin(data.user);
          } else {
            const { data, error } = await supabaseClient.auth.signUp({ email, password });
            if (error) throw error;
            if (data.user) onLogin(data.user);
          }
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen bg-gray-900 flex items-center justify-center p-4">
          <div className="fixed inset-0 bg-gradient-to-br from-gray-900 via-gray-900 to-gray-800 pointer-events-none" />
          <div className="fixed top-0 right-0 w-96 h-96 bg-cyan-500/10 rounded-full blur-3xl pointer-events-none" />
          <div className="fixed bottom-0 left-0 w-96 h-96 bg-emerald-500/10 rounded-full blur-3xl pointer-events-none" />
          
          <div className="relative bg-gray-800 border border-gray-700 rounded-2xl p-8 w-full max-w-md">
            <div className="text-center mb-8">
              <h1 className="text-3xl font-bold text-white mb-2">Revenue Compass</h1>
              <p className="text-gray-400">Income tracker for personal trainers</p>
            </div>

            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-gray-400 text-sm mb-2">Email</label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-3 text-white focus:border-cyan-500 focus:outline-none"
                  placeholder="you@example.com"
                  required
                />
              </div>
              <div>
                <label className="block text-gray-400 text-sm mb-2">Password</label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-3 text-white focus:border-cyan-500 focus:outline-none"
                  placeholder="Min 6 characters"
                  required
                  minLength={6}
                />
              </div>

              {error && (
                <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-3 text-red-400 text-sm">
                  {error}
                </div>
              )}

              <button
                type="submit"
                disabled={loading}
                className="w-full py-3 bg-cyan-500 hover:bg-cyan-400 disabled:bg-gray-600 text-gray-900 font-semibold rounded-xl transition-colors"
              >
                {loading ? 'Loading...' : isLogin ? 'Sign In' : 'Create Account'}
              </button>
            </form>

            <p className="text-center mt-6 text-gray-400">
              {isLogin ? "Don't have an account?" : "Already have an account?"}{' '}
              <button onClick={() => setIsLogin(!isLogin)} className="text-cyan-400 hover:text-cyan-300">
                {isLogin ? 'Sign Up' : 'Sign In'}
              </button>
            </p>
          </div>
        </div>
      );
    };

    const App = () => {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [clients, setClients] = useState([]);
      const [payments, setPayments] = useState([]);
      const [monthlyIncome, setMonthlyIncome] = useState([]);
      const [targets, setTargets] = useState([]);
      const [showNewClientModal, setShowNewClientModal] = useState(false);
      const [showPaymentModal, setShowPaymentModal] = useState(false);
      const [newClient, setNewClient] = useState({ name: '', email: '', phone: '' });
      const [newPayment, setNewPayment] = useState({ client_id: '', type: 'Pack', amount: '', sessions: '' });

      useEffect(() => {
        supabaseClient.auth.getSession().then(({ data: { session } }) => {
          setUser(session?.user ?? null);
          setLoading(false);
        });

        const { data: { subscription } } = supabaseClient.auth.onAuthStateChange((_event, session) => {
          setUser(session?.user ?? null);
        });

        return () => subscription.unsubscribe();
      }, []);

      useEffect(() => {
        if (user) fetchAllData();
      }, [user]);

      const fetchAllData = async () => {
        const [clientsRes, paymentsRes, incomeRes, targetsRes] = await Promise.all([
          supabaseClient.from('clients').select('*').order('created_at', { ascending: false }),
          supabaseClient.from('payments').select('*, clients(name)').order('date', { ascending: false }),
          supabaseClient.from('monthly_income').select('*').order('month_number', { ascending: true }),
          supabaseClient.from('targets').select('*')
        ]);
        
        setClients(clientsRes.data || []);
        setPayments(paymentsRes.data || []);
        setMonthlyIncome(incomeRes.data || []);
        
        if (targetsRes.data && targetsRes.data.length === 0) {
          const defaultTargets = [
            { target_name: 'Monthly Revenue', current_value: 0, goal: 5000, user_id: user.id },
            { target_name: 'Active Clients', current_value: 0, goal: 15, user_id: user.id },
          ];
          await supabaseClient.from('targets').insert(defaultTargets);
          setTargets(defaultTargets);
        } else {
          setTargets(targetsRes.data || []);
        }
      };

      const handleAddClient = async () => {
        if (!newClient.name.trim()) return;
        const { error } = await supabaseClient.from('clients').insert([
          { ...newClient, user_id: user.id, status: 'Active' }
        ]);
        if (!error) {
          setNewClient({ name: '', email: '', phone: '' });
          setShowNewClientModal(false);
          fetchAllData();
        }
      };

      const handleAddPayment = async () => {
        if (!newPayment.client_id || !newPayment.amount || !newPayment.sessions) return;
        const { error } = await supabaseClient.from('payments').insert([{
          client_id: newPayment.client_id,
          type: newPayment.type,
          amount: parseFloat(newPayment.amount),
          sessions: parseInt(newPayment.sessions),
          sessions_completed: 0,
          user_id: user.id,
          date: new Date().toISOString().split('T')[0]
        }]);
        if (!error) {
          setNewPayment({ client_id: '', type: 'Pack', amount: '', sessions: '' });
          setShowPaymentModal(false);
          fetchAllData();
        }
      };

      const toggleSession = async (paymentId, currentCompleted, totalSessions) => {
        if (currentCompleted >= totalSessions) return;
        await supabaseClient.from('payments').update({ sessions_completed: currentCompleted + 1 }).eq('id', paymentId);
        fetchAllData();
      };

      const handleLogout = async () => {
        await supabaseClient.auth.signOut();
        setUser(null);
      };

      const totalRevenue = payments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
      const thisMonthRevenue = payments
        .filter(p => new Date(p.date).getMonth() === new Date().getMonth())
        .reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
      const activeClients = clients.filter(c => c.status === 'Active').length;
      const renewalsSoon = payments.filter(p => (p.sessions - p.sessions_completed) <= 2 && (p.sessions - p.sessions_completed) > 0);

      if (loading) {
        return (
          <div className="min-h-screen bg-gray-900 flex items-center justify-center">
            <div className="text-cyan-400 text-xl">Loading...</div>
          </div>
        );
      }

      if (!user) {
        return <AuthScreen onLogin={setUser} />;
      }

      return (
        <div className="min-h-screen bg-gray-900 text-white">
          <div className="fixed inset-0 bg-gradient-to-br from-gray-900 via-gray-900 to-gray-800 pointer-events-none" />
          <div className="fixed top-0 right-0 w-96 h-96 bg-cyan-500/10 rounded-full blur-3xl pointer-events-none" />
          <div className="fixed bottom-0 left-0 w-96 h-96 bg-emerald-500/10 rounded-full blur-3xl pointer-events-none" />

          {showNewClientModal && (
            <Modal title="New Client" onClose={() => setShowNewClientModal(false)}>
              <div className="space-y-4">
                <div>
                  <label className="block text-gray-400 text-sm mb-2">Name *</label>
                  <input type="text" value={newClient.name} onChange={(e) => setNewClient({ ...newClient, name: e.target.value })}
                    className="w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-3 text-white focus:border-cyan-500 focus:outline-none" placeholder="Client name" />
                </div>
                <div>
                  <label className="block text-gray-400 text-sm mb-2">Email</label>
                  <input type="email" value={newClient.email} onChange={(e) => setNewClient({ ...newClient, email: e.target.value })}
                    className="w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-3 text-white focus:border-cyan-500 focus:outline-none" placeholder="email@example.com" />
                </div>
                <div>
                  <label className="block text-gray-400 text-sm mb-2">Phone</label>
                  <input type="tel" value={newClient.phone} onChange={(e) => setNewClient({ ...newClient, phone: e.target.value })}
                    className="w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-3 text-white focus:border-cyan-500 focus:outline-none" placeholder="+1 234 567 890" />
                </div>
                <div className="flex gap-3 pt-4">
                  <button onClick={() => setShowNewClientModal(false)} className="flex-1 px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl font-medium">Cancel</button>
                  <button onClick={handleAddClient} disabled={!newClient.name.trim()} className="flex-1 px-4 py-3 bg-cyan-500 hover:bg-cyan-400 disabled:bg-gray-600 text-gray-900 rounded-xl font-medium">Add Client</button>
                </div>
              </div>
            </Modal>
          )}

          {showPaymentModal && (
            <Modal title="Add Payment" onClose={() => setShowPaymentModal(false)}>
              <div className="space-y-4">
                <div>
                  <label className="block text-gray-400 text-sm mb-2">Client *</label>
                  <select value={newPayment.client_id} onChange={(e) => setNewPayment({ ...newPayment, client_id: e.target.value })}
                    className="w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-3 text-white focus:border-cyan-500 focus:outline-none">
                    <option value="">Select client...</option>
                    {clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-gray-400 text-sm mb-2">Type</label>
                  <div className="grid grid-cols-3 gap-2">
                    {['Single', 'Pack', 'Monthly'].map(type => (
                      <button key={type} onClick={() => setNewPayment({ ...newPayment, type })}
                        className={`p-3 rounded-xl border transition-all ${newPayment.type === type ? 'bg-cyan-500/20 border-cyan-500 text-cyan-400' : 'bg-gray-700/50 border-gray-600 text-gray-300'}`}>
                        {type}
                      </button>
                    ))}
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-gray-400 text-sm mb-2">Amount (â‚¬) *</label>
                    <input type="number" value={newPayment.amount} onChange={(e) => setNewPayment({ ...newPayment, amount: e.target.value })}
                      className="w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-3 text-white focus:border-cyan-500 focus:outline-none" placeholder="0.00" />
                  </div>
                  <div>
                    <label className="block text-gray-400 text-sm mb-2">Sessions *</label>
                    <input type="number" value={newPayment.sessions} onChange={(e) => setNewPayment({ ...newPayment, sessions: e.target.value })}
                      className="w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-3 text-white focus:border-cyan-500 focus:outline-none" placeholder="0" />
                  </div>
                </div>
                {newPayment.amount && newPayment.sessions && (
                  <div className="bg-gray-700/50 rounded-xl p-4">
                    <div className="flex items-center justify-between">
                      <span className="text-gray-400">Price per session:</span>
                      <span className="text-xl font-bold text-yellow-400">â‚¬{(parseFloat(newPayment.amount) / parseInt(newPayment.sessions)).toFixed(2)}</span>
                    </div>
                  </div>
                )}
                <div className="flex gap-3 pt-4">
                  <button onClick={() => setShowPaymentModal(false)} className="flex-1 px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl font-medium">Cancel</button>
                  <button onClick={handleAddPayment} disabled={!newPayment.client_id || !newPayment.amount || !newPayment.sessions}
                    className="flex-1 px-4 py-3 bg-cyan-500 hover:bg-cyan-400 disabled:bg-gray-600 text-gray-900 rounded-xl font-medium">Add Payment</button>
                </div>
              </div>
            </Modal>
          )}

          <div className="relative">
            <header className="border-b border-gray-800 bg-gray-900/80 backdrop-blur-xl sticky top-0 z-10">
              <div className="max-w-6xl mx-auto px-4 sm:px-6 py-5">
                <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                  <div>
                    <h1 className="text-2xl font-bold">Revenue Compass</h1>
                    <p className="text-gray-500 text-sm">Personal Training Dashboard</p>
                  </div>
                  <div className="flex items-center gap-2 flex-wrap">
                    <button onClick={() => setShowNewClientModal(true)} className="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white font-medium rounded-xl transition-colors text-sm">
                      + New Client
                    </button>
                    <button onClick={() => setShowPaymentModal(true)} className="px-4 py-2 bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-medium rounded-xl transition-colors text-sm">
                      + Add Payment
                    </button>
                    <button onClick={handleLogout} className="px-4 py-2 text-gray-400 hover:text-white transition-colors text-sm">
                      Logout
                    </button>
                  </div>
                </div>
              </div>
            </header>

            <main className="max-w-6xl mx-auto px-4 sm:px-6 py-8">
              <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <MetricCard icon="ðŸ’°" value={`â‚¬${thisMonthRevenue.toLocaleString()}`} label="This Month" color="bg-emerald-500/20" />
                <MetricCard icon="ðŸ“ˆ" value={`â‚¬${totalRevenue.toLocaleString()}`} label="Total Revenue" color="bg-cyan-500/20" />
                <MetricCard icon="ðŸ‘¥" value={activeClients} label="Active Clients" color="bg-purple-500/20" />
                <MetricCard icon="âš ï¸" value={renewalsSoon.length} label="Renewals Soon" color="bg-orange-500/20" />
              </div>

              <div className="bg-gray-800/50 backdrop-blur border border-gray-700/50 rounded-2xl p-6 mb-8">
                <h3 className="text-lg font-semibold mb-6">ðŸ’Ž Revenue Per Client</h3>
                {clients.length === 0 ? (
                  <p className="text-gray-500 text-center py-8">No clients yet. Add your first client!</p>
                ) : (
                  <div className="space-y-3">
                    {clients.map((client, i) => {
                      const clientPayments = payments.filter(p => p.client_id === client.id);
                      const revenue = clientPayments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
                      const maxRevenue = Math.max(...clients.map(c => payments.filter(p => p.client_id === c.id).reduce((sum, p) => sum + parseFloat(p.amount || 0), 0)), 1);
                      const colors = ['from-cyan-500 to-cyan-400', 'from-purple-500 to-purple-400', 'from-emerald-500 to-emerald-400', 'from-orange-500 to-orange-400'];
                      return (
                        <div key={client.id}>
                          <div className="flex items-center justify-between mb-1">
                            <div className="flex items-center gap-2">
                              <div className={`w-6 h-6 rounded-full bg-gradient-to-br ${colors[i % colors.length]} flex items-center justify-center text-white text-xs font-semibold`}>
                                {client.name?.split(' ').map(n => n[0]).join('')}
                              </div>
                              <span className="text-gray-300 text-sm">{client.name}</span>
                            </div>
                            <span className="text-white font-semibold text-sm">â‚¬{revenue.toLocaleString()}</span>
                          </div>
                          <div className="h-2 bg-gray-700 rounded-full overflow-hidden">
                            <div className={`h-full rounded-full bg-gradient-to-r ${colors[i % colors.length]}`} style={{ width: `${(revenue / maxRevenue) * 100}%` }} />
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>

              <div className="bg-gray-800/50 backdrop-blur border border-cyan-500/30 rounded-2xl p-6 mb-8">
                <h3 className="text-lg font-semibold mb-6">âœ… Session Tracker</h3>
                {payments.length === 0 ? (
                  <p className="text-gray-500 text-center py-8">No payments yet. Add a payment to track sessions!</p>
                ) : (
                  <div className="space-y-4">
                    {payments.map(payment => (
                      <div key={payment.id} className="bg-gray-800/30 rounded-xl border border-gray-700/30 p-4">
                        <div className="flex items-center justify-between mb-3">
                          <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white font-semibold text-sm">
                              {payment.clients?.name?.split(' ').map(n => n[0]).join('') || '?'}
                            </div>
                            <div>
                              <div className="text-white font-medium">{payment.clients?.name || 'Unknown'}</div>
                              <div className="text-xs text-gray-400">{payment.type} â€¢ â‚¬{payment.amount}</div>
                            </div>
                          </div>
                          <div className="text-right">
                            <div className="text-white font-semibold">{payment.sessions_completed}/{payment.sessions}</div>
                            <div className={`text-xs ${payment.sessions - payment.sessions_completed <= 2 ? 'text-orange-400' : 'text-gray-400'}`}>
                              {payment.sessions - payment.sessions_completed} left
                            </div>
                          </div>
                        </div>
                        <div className="flex flex-wrap gap-2">
                          {Array.from({ length: payment.sessions }, (_, i) => (
                            <button
                              key={i}
                              onClick={() => i === payment.sessions_completed && toggleSession(payment.id, payment.sessions_completed, payment.sessions)}
                              className={`w-8 h-8 rounded-lg flex items-center justify-center text-xs font-medium transition-all ${
                                i < payment.sessions_completed 
                                  ? 'bg-emerald-500/20 border border-emerald-500/50 text-emerald-400' 
                                  : i === payment.sessions_completed
                                  ? 'bg-gray-700/50 border border-cyan-500/50 text-cyan-400 hover:bg-cyan-500/20 cursor-pointer'
                                  : 'bg-gray-700/30 border border-gray-600/30 text-gray-500'
                              }`}
                            >
                              {i < payment.sessions_completed ? 'âœ“' : i + 1}
                            </button>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              <div className="bg-gray-800/50 backdrop-blur border border-yellow-500/30 rounded-2xl p-6">
                <h3 className="text-lg font-semibold mb-6">ðŸ’µ Price Per Session</h3>
                {payments.length === 0 ? (
                  <p className="text-gray-500 text-center py-8">No pricing data yet.</p>
                ) : (
                  <div className="bg-gradient-to-r from-yellow-500/10 to-amber-500/10 border border-yellow-500/30 rounded-xl p-4">
                    <div className="flex items-center justify-between">
                      <div>
                        <div className="text-gray-400 text-sm">Average Price Per Session</div>
                        <div className="text-3xl font-bold text-yellow-400">
                          â‚¬{(payments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0) / payments.reduce((sum, p) => sum + (p.sessions || 0), 0) || 0).toFixed(2)}
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="text-gray-400 text-sm">Total Sessions</div>
                        <div className="text-xl font-semibold text-white">{payments.reduce((sum, p) => sum + (p.sessions || 0), 0)}</div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </main>
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
